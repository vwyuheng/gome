<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="tuan-inventory" >
	<!-- 商品商家库存信息-->	
	<resultMap id="GoodsSuppliersInventoryResult" class="com.tuan.inventory.dao.data.GoodsSuppliersInventoryDO">
	    <result column="id" property="id" jdbcType="INTEGER" />
	    <result column="goods_id" property="goodsId" jdbcType="INTEGER" />
	    <result column="suppliers_id" property="suppliersId" jdbcType="INTEGER" />
	    <result column="STATUS" property="status" jdbcType="INTEGER" />
	    <result column="totalNumber" property="totalNumber" jdbcType="INTEGER" />
	    <result column="leftNumber" property="leftNumber" jdbcType="INTEGER" />
	    <result column="addTotalNumber" property="addTotalNumber" jdbcType="INTEGER" />
	    <result column="reduceTotalNumber" property="reduceTotalNumber" jdbcType="INTEGER" />
	    <result column="limitNumber" property="limitNumber" jdbcType="INTEGER" />
	    <result column="settlement" property="settlement" jdbcType="INTEGER" />
	    <result column="validMsgGet" property="validMsgGet" jdbcType="INTEGER" />
	    <result column="totalNum_display_font" property="totalNumDisplayFont" jdbcType="INTEGER" />
	    <result column="limit_storage" property="limitStorage" jdbcType="INTEGER" />
	 </resultMap>
	<!-- 非选型商品实时库存信息-->	
	<resultMap id="GoodsAttributeInventoryResult" class="com.tuan.inventory.dao.data.GoodsAttributeInventoryDO">
	    <result column="goods_id" property="goodsId" jdbcType="INTEGER" />
	    <result column="total_num" property="totalNumber" jdbcType="INTEGER" />
	    <result column="left_num" property="leftNumber" jdbcType="INTEGER" />
	    <result column="limit_storage" property="limitStorage" jdbcType="INTEGER" />
	 </resultMap>
	<!-- 分店配型信息-->	
	<resultMap id="GoodsSelectionRelationResult" class="com.tuan.inventory.dao.data.GoodsSelectionRelationDO">
	    <result column="id" property="id" jdbcType="INTEGER" />
	    <result column="suppliers_id" property="suppliersId" jdbcType="INTEGER" />
	    <result column="STATUS" property="status" jdbcType="INTEGER" />
	    <result column="good_type_id" property="goodTypeId" jdbcType="INTEGER" />
	    <result column="ImageURL" property="ImageURL" jdbcType="VARCHAR" />
	    <result column="totalNumber" property="totalNumber" jdbcType="INTEGER" />
	    <result column="leftNumber" property="leftNumber" jdbcType="INTEGER" />
	    <result column="addTotalNumber" property="addTotalNumber" jdbcType="INTEGER" />
	    <result column="reduceTotalNumber" property="reduceTotalNumber" jdbcType="INTEGER" />
	    <result column="limitNumber" property="limitNumber" jdbcType="INTEGER" />
	    <result column="suppliers_sub_id" property="suppliersSubId" jdbcType="INTEGER" />
	    <result column="leftTotalNum_display_font" property="leftTotalNumDisplayFont" jdbcType="INTEGER" />
	    <result column="limit_storage" property="limitStorage" jdbcType="INTEGER" />   	    
	 </resultMap>	
  	 
	<resultMap id="GoodsSelectionRelationAndGoodsResult" class="com.tuan.inventory.dao.data.GoodsSelectionRelationGoodDO">
	    <result column="id" property="id" jdbcType="INTEGER" />
	    <result column="suppliers_id" property="suppliersId" jdbcType="INTEGER" />
	    <result column="STATUS" property="status" jdbcType="INTEGER" />
	    <result column="good_type_id" property="goodTypeId" jdbcType="INTEGER" />
	    <result column="ImageURL" property="ImageURL" jdbcType="VARCHAR" />
	    <result column="totalNumber" property="totalNumber" jdbcType="INTEGER" />
	    <result column="leftNumber" property="leftNumber" jdbcType="INTEGER" />
	    <result column="addTotalNumber" property="addTotalNumber" jdbcType="INTEGER" />
	    <result column="reduceTotalNumber" property="reduceTotalNumber" jdbcType="INTEGER" />
	    <result column="limitNumber" property="limitNumber" jdbcType="INTEGER" />
	    <result column="suppliers_sub_id" property="suppliersSubId" jdbcType="INTEGER" />
	    <result column="leftTotalNum_display_font" property="leftTotalNumDisplayFont" jdbcType="INTEGER" />
	    <result column="limit_storage" property="limitStorage" jdbcType="INTEGER" />   	    
	    <result column="goodId" property="goodId" jdbcType="INTEGER" />
	    <result column="name" property="name" jdbcType="VARCHAR" />
	 </resultMap>	
  
	<!-- 通过商品ID查询商品商家库存信息  -->	
	<select id="selectGoodsSuppliersInventoryBySiId" resultMap="GoodsSuppliersInventoryResult"  parameterClass="int">
		select gsi.id,gsi.addTotalNumber,gsi.goods_id,gsi.leftNumber,
			gsi.limitNumber,gsi.reduceTotalNumber,gsi.settlement,gsi.`STATUS`,gsi.suppliers_id,
			gsi.totalNumber,gsi.totalNum_display_font,gsi.validMsgGet,gsi.limit_storage 
		from jeehe_goods_suppliers_inventory gsi where gsi.`STATUS` = 0 and gsi.id = #suppliersSubId:INTEGER#
	</select>
	
	<!-- 通过分店配型关系表ID获得该分店选型信息   -->	
	<select id="selectSelectionRelationBySrId" resultMap="GoodsSelectionRelationResult" parameterClass="int" >
		select sr.id,sr.addTotalNumber,sr.good_type_id,sr.ImageURL,
			sr.leftNumber,sr.limitNumber,sr.reduceTotalNumber,sr.`STATUS`,sr.suppliers_id,
			sr.suppliers_sub_id,sr.totalNumber,sr.leftTotalNum_display_font,sr.limit_storage 
		from jeehe_selection_relation sr where sr.`STATUS` = 0 and sr.id = #selectionRelationId:INTEGER#
	</select>
  
	
	<!-- 更新分店库存   -->	
    <update id="updateSuppliersInventoryLeftNumberBySiID" parameterClass="com.tuan.inventory.dao.data.OrderInfoDetailDO" >
       update jeehe_goods_suppliers_inventory
      <dynamic prepend="set" >
        <isNotNull prepend="," property="count">
			leftNumber =leftNumber-#count:INTEGER#
		</isNotNull>
      </dynamic>
      where id = #suppliersId:INTEGER# and `status` = 0  and limit_storage = 1
    </update>
    <!-- 更新选型库存  -->	
    <update id="updateSelectionRelationLeftNumberBySID" parameterClass="com.tuan.inventory.dao.data.OrderInfoDetailDO" >
       update jeehe_selection_relation
      <dynamic prepend="set" >
        <isNotNull prepend="," property="count">
			leftNumber =leftNumber-#count:INTEGER#
		</isNotNull>
      </dynamic>
      where id = #selectionRelationId:INTEGER# and `status` = 0 and limit_storage = 1 
    </update>
    <!-- 更新商品库存   -->	
    <update id="updateGoodsAttributesLeftNumberByGID" parameterClass="com.tuan.inventory.dao.data.OrderGoodsDO" >
      update jeehe_goods_attribute
      <dynamic prepend="set" >
        <isNotNull prepend="," property="goodsNumber">
			left_num =left_num-#goodsNumber:INTEGER#
		</isNotNull>
      </dynamic>
      where goods_id = #goodsId:INTEGER#  and limit_storage = 1
    </update>
    
    <!--   -->
	<update id="updataGoodsWmsLeftNumByID" parameterClass="com.tuan.inventory.dao.data.WmsGoodsDO">
		 update jeehe_goods_wms
		<dynamic prepend="set">
			<isNotNull prepend="," property="totalNum">
				left_num = left_num - #totalNum:INTEGER#
      		</isNotNull>
		</dynamic>
		where id = #id:LONG# 
	</update>
	<update id="set_sql_model_user"  >
		set sql_mode='STRICT_TRANS_TABLES'
	</update>
	<update id="set_sql_model_sys"  >
		set sql_mode='NO_AUTO_CREATE_USER'
	</update>
	
	<!-- 通过分店配型关系表ID获得该分店选型信息   -->	
	<select id="selectSelectionRelationBySrIdAndGoodsId" resultMap="GoodsSelectionRelationAndGoodsResult" parameterClass="java.util.Map" >
		select sr.id,sr.addTotalNumber,sr.good_type_id,sr.ImageURL,
			sr.leftNumber,sr.limitNumber,sr.reduceTotalNumber,sr.`STATUS`,sr.suppliers_id,
			sr.suppliers_sub_id,sr.totalNumber,sr.leftTotalNum_display_font,sr.limit_storage,gt.goodId,gt.name  
		from jeehe_selection_relation sr ,jeehe_good_type gt 
		where gt.id=sr.good_type_id and gt.`status`=0 
			  and sr.`STATUS` = 0 
    <dynamic >
	<isNotNull prepend="and" property="selectionRelationId" > sr.id = #selectionRelationId:BIGINT#</isNotNull>
	<isNotNull prepend="and" property="goodsId" > gt.goodId = #goodsId:BIGINT#</isNotNull>
	</dynamic>			  
	</select>
	
	<!-- 通过分店配型关系表IDs获得该分店选型信息   -->	
	<select id="selectSelectionRelationBySrIds" resultMap="GoodsSelectionRelationAndGoodsResult" parameterClass="java.util.Map" >
		select sr.id,sr.addTotalNumber,sr.good_type_id,sr.ImageURL,
			sr.leftNumber,sr.limitNumber,sr.reduceTotalNumber,sr.`STATUS`,sr.suppliers_id,
			sr.suppliers_sub_id,sr.totalNumber,sr.leftTotalNum_display_font,sr.limit_storage,gt.goodId,gt.name  
		from jeehe_selection_relation sr ,jeehe_good_type gt 
		where gt.id=sr.good_type_id  
    <dynamic >
	    <isNotNull prepend="and" property="selectionRelationIdList" > 
	        sr.id in 
	        <iterate property="selectionRelationIdList" open="(" close=")" conjunction=",">
	            #selectionRelationIdList[]:BIGINT#
	        </iterate>
	    </isNotNull>
	</dynamic>			  
	</select>
	
	<!-- 通过商品ID查询非选型实物商品的库存  -->	
	<select id="selectGoodsNotSelectionInventoryByGoodsId" resultMap="GoodsAttributeInventoryResult"  parameterClass="java.lang.Long">
		select goods_id,total_num,left_num,limit_storage 
		from jeehe_goods_attribute where goods_id = #goodsId:BIGINT#
	</select>
</sqlMap>